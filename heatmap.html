<!doctype html>
<html>
<head>
  <title>HeatMap des Mobilisations</title>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>
  <style>
    .map {
      width:800px;
      height:600px;
    }
  </style>

  <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
    integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
    crossorigin=""></script>
  <script src="leaflet-timeline-slider.js"></script>
  <script src="leaflet-heat.js"></script>
</head>
<body>
  <div class="map">
    <noscript>
      This example requires javascript.
    </noscript>
  </div>

  <script>
    (function () {
        // Load data      
        var FEEDS = [
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/autres.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/culture.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/education.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/esr.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/indus_energie.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/justice.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/multi.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/sante.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/securite.geojson',
        'https://raw.githubusercontent.com/geographesESR/cartographie-des-mouvements-sociaux/master/transport.geojson'
        ];
      var NOW = new Date();

      // load data asynchronously
      var data = [];
      FEEDS.forEach(function(item, index, array) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            var results = JSON.parse(xhr.responseText);
            results.features.forEach(function(feature){
                data.push(feature);
            });
        };
        xhr.open('GET', item, true);
        xhr.send();
      });

      // create map
      var map = L.map(document.querySelector('.map'));
      // center in colorado
      map.setView([47, 2], 6);
      // add basemap
      L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
          /**
           * http://services.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer?f=pjson
           * copyrightText
           */
          attribution: 'Sources: Geographes ESR - Cartographie des mouvements sociaux'
          }).addTo(map);

      // init heatmap
      var heatLayer = L.heatLayer([], {maxZoom: 12});
      map.addLayer(heatLayer);
      var eventLayer = L.geoJson();
      map.addLayer(eventLayer);

      getDataAddMarkers = function( {label, value, map, exclamation} ) {
          var selected = (new Date(label)).getTime();
          
          // Clear layers
          map.removeLayer(heatLayer);
          map.removeLayer(eventLayer);

          // Filter events before selected date
          var filteredData = [];
          var heatMapData = [];
          data.forEach(function (d) {
                var start = (new Date(d.properties.Debut)).getTime();
                var end = (new Date(d.properties.Fin)).getTime();
                if (isNaN(start) 
                    || (start <= selected && (isNaN(end) || end >= selected))) 
                {
                    filteredData.push(d);
                    heatMapData.push(
                        new L.latLng(
                            d.geometry.coordinates[1],
                            d.geometry.coordinates[0], 
                            10.0
                        )
                    );
                }
            });
          
          //* Add event points
          eventLayer = L.geoJson(filteredData, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, {
                            color: '#FF0000',
                            radius: 1
                        });
                    }
                }).addTo(map);
          map.addLayer(eventLayer);
          //*/

          // Heat map
          heatLayer = L.heatLayer(heatMapData, {maxZoom: 12});
          map.addLayer(heatLayer);
      };
    
      L.control.timelineSlider({
        position: "topright",
        timelineItems: [
                "05/12/2019", 
                "12/12/2019", 
                "19/12/2019", 
                "26/12/2019",
                "02/01/2020",
                "09/01/2020",
                "16/01/2020",
                "23/01/2020",
                "30/01/2020"
            ],
        changeMap: getDataAddMarkers
      }).addTo(map);    
    })();
  </script>
</body>
</html>
